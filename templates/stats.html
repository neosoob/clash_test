<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>连通性统计</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "PingFang SC", sans-serif;
      color: var(--text);
      background: linear-gradient(120deg, #e2e8f0, #f8fafc);
      min-height: 100vh;
      padding: 20px;
    }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .stat {
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 24px rgba(2, 6, 23, .08);
      border: 1px solid transparent;
    }
    .stat h3 { margin: 0; font-size: 13px; color: var(--muted); }
    .stat p { margin: 8px 0 0; font-size: 22px; font-weight: 700; }
    .stat .sub { margin-top: 6px; font-size: 12px; color: var(--muted); }
    .stat.status-green {
      background: #ecfdf5;
      border-color: #10b981;
    }
    .stat.status-red {
      background: #fef2f2;
      border-color: #ef4444;
    }
    .charts {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .panel {
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 24px rgba(2, 6, 23, .08);
      min-height: 280px;
    }
    .panel h2 { margin: 0 0 8px; font-size: 15px; }
    .table-wrap { border: 1px solid #e2e8f0; border-radius: 8px; overflow: visible; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    th { background: #f8fafc; position: sticky; top: 0; z-index: 1; }
    .bar-track {
      width: 60px;
      height: 10px;
      background: #e2e8f0;
      border-radius: 0;
      overflow: hidden;
      position: relative;
    }
    .bar-fill { height: 100%; border-radius: 0; }
    .bar-fill.fail { background: #ef4444; }
    .bar-fill.fail-pred {
      background: #fca5a5;
      position: absolute;
      top: 0;
      border-radius: 0;
    }
    .bar-fill.rate { background: #2563eb; }
    .log-box {
      width: 100%;
      min-height: 260px;
      resize: vertical;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px;
      font-family: Consolas, "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
      background: #0b1220;
      color: #e2e8f0;
      white-space: pre;
      overflow-x: auto;
    }
    .span-2 { grid-column: span 2; }
    .actions { margin: 12px 0; display: flex; gap: 8px; }
    button {
      border: none;
      background: #0f766e;
      color: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    button.alt { background: #334155; }
    @media (max-width: 920px) {
      .row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .charts { grid-template-columns: 1fr; }
      .span-2 { grid-column: span 1; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>连通性统计图表</h1>
    <div class="actions">
      <button onclick="loadStats()">刷新数据</button>
      <button class="alt" onclick="location.href='/'">返回测试页</button>
    </div>

    <section class="row">
      <div id="totalStatCard" class="stat"><h3>总测试次数</h3><p id="total">0</p><div id="lastTestTime" class="sub">最近测试时间: -</div></div>
      <div class="stat"><h3>成功次数</h3><p id="success">0</p></div>
      <div id="failedStatCard" class="stat"><h3>失败次数</h3><p id="failed">0</p><div id="lastFailedTime" class="sub">最近失败时间: -</div><div id="consecutiveFailedCount" class="sub">连续失败次数: 0</div></div>
      <div class="stat"><h3>成功率 / 平均延迟</h3><p id="rate">0% / -</p></div>
    </section>

    <section class="charts">
      <div class="panel">
        <h2>最近24小时每小时失败次数与连通率</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>小时</th>
                <th>失败次数</th>
                <th>失败次数条形</th>
                <th>连通率</th>
                <th>连通率条形</th>
              </tr>
            </thead>
            <tbody id="hourly24Body"></tbody>
          </table>
        </div>
      </div>
      <div class="panel">
        <h2>成功/失败占比</h2>
        <canvas id="pieChart"></canvas>
      </div>
      <div class="panel">
        <h2>按小时失败次数（柱状图）</h2>
        <canvas id="failBarChart"></canvas>
      </div>
      <div class="panel">
        <h2>按小时连通率（折线图）</h2>
        <canvas id="rateLineChart"></canvas>
      </div>
      <div class="panel span-2">
        <h2>connectivity_log.txt 内容</h2>
        <textarea id="logContent" class="log-box" readonly wrap="off"></textarea>
      </div>
    </section>
  </div>

  <script>
    const chartInstances = {};
    const valueLabelPlugin = {
      id: 'valueLabelPlugin',
      afterDatasetsDraw(chart) {
        const { ctx } = chart;
        const chartId = chart.canvas.id;

        if (chartId === 'pieChart') {
          const ds = chart.data.datasets[0];
          const total = (ds?.data || []).reduce((sum, n) => sum + Number(n || 0), 0);
          if (!total) return;

          const meta = chart.getDatasetMeta(0);
          ctx.save();
          ctx.fillStyle = '#ffffff';
          ctx.font = 'bold 12px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          meta.data.forEach((arc, i) => {
            const raw = Number(ds.data[i] || 0);
            if (raw <= 0) return;
            const pct = ((raw / total) * 100).toFixed(1) + '%';
            const pos = arc.tooltipPosition();
            ctx.fillText(pct, pos.x, pos.y);
          });
          ctx.restore();
          return;
        }

        if (chartId === 'failBarChart') {
          const failDatasetIndex = chart.data.datasets.findIndex(ds => ds.label === '失败次数');

          ctx.save();
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          ctx.font = '12px sans-serif';

          if (failDatasetIndex !== -1) {
            const metaFail = chart.getDatasetMeta(failDatasetIndex);
            const failDataset = chart.data.datasets[failDatasetIndex];
            const failValues = failDataset.data;
            const rateValues = failDataset.rateValues || [];
            ctx.fillStyle = '#7f1d1d';
            metaFail.data.forEach((bar, i) => {
              const value = failValues[i];
              if (value === null || value === undefined) return;
              const rate = Math.round(Number(rateValues[i] || 0));
              ctx.fillText(`${value} (${rate}%)`, bar.x + 6, bar.y);
            });
          }
          ctx.restore();
          return;
        }

        if (chartId === 'rateLineChart') {
          const rateDatasetIndex = chart.data.datasets.findIndex(ds => ds.label === '连通率(%)');
          if (rateDatasetIndex === -1) return;

          const metaRate = chart.getDatasetMeta(rateDatasetIndex);
          const rateValues = chart.data.datasets[rateDatasetIndex].data;
          ctx.save();
          ctx.fillStyle = '#1e3a8a';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.font = '12px sans-serif';
          metaRate.data.forEach((pt, i) => {
            const value = rateValues[i];
            if (value === null || value === undefined) return;
            ctx.fillText(`${value}%`, pt.x, pt.y - 8);
          });
          ctx.restore();
        }
      }
    };

    function drawChart(id, config) {
      if (chartInstances[id]) {
        chartInstances[id].destroy();
      }
      const ctx = document.getElementById(id);
      chartInstances[id] = new Chart(ctx, {
        ...config,
        plugins: [...(config.plugins || []), valueLabelPlugin]
      });
    }

    async function loadStats() {
      const [statsResp, logResp] = await Promise.all([
        fetch('/api/stats'),
        fetch('/api/log')
      ]);
      const data = await statsResp.json();
      const logData = await logResp.json();
      const s = data.summary;

      document.getElementById('total').textContent = s.total;
      document.getElementById('success').textContent = s.success;
      document.getElementById('failed').textContent = s.failed;
      document.getElementById('rate').textContent = `${s.success_rate}% / ${s.avg_latency_ms ?? '-'} ms`;
      document.getElementById('lastTestTime').textContent = `最近测试时间: ${s.last_test_time ?? '-'}`;
      document.getElementById('lastFailedTime').textContent = `最近失败时间: ${s.last_failed_time ?? '-'}`;
      document.getElementById('consecutiveFailedCount').textContent = `连续失败次数: ${s.consecutive_failed_count ?? 0}`;
      const totalCard = document.getElementById('totalStatCard');
      const failedCard = document.getElementById('failedStatCard');
      totalCard.classList.remove('status-red', 'status-green');
      failedCard.classList.remove('status-red', 'status-green');
      if ((s.last_test_time ?? '-') !== '-' && s.last_test_time === s.last_failed_time) {
        totalCard.classList.add('status-red');
        failedCard.classList.add('status-red');
      } else {
        totalCard.classList.add('status-green');
        failedCard.classList.add('status-green');
      }

      drawChart('pieChart', {
        type: 'pie',
        data: {
          labels: ['成功', '失败'],
          datasets: [{ data: [s.success, s.failed], backgroundColor: ['#10b981', '#ef4444'] }]
        }
      });

      const hours = Object.keys(data.hourly).sort();
      const hoursDesc = [...hours].reverse();
      const successList = hours.map(h => data.hourly[h].success || 0);
      const failList = hours.map(h => data.hourly[h].failed || 0);
      const failListDesc = hoursDesc.map(h => data.hourly[h].failed || 0);
      const rateList = hours.map((_, i) => {
        const total = successList[i] + failList[i];
        return total > 0 ? Math.round((successList[i] / total) * 100) : 0;
      });
      drawChart('failBarChart', {
        type: 'bar',
        data: {
          labels: hoursDesc,
          datasets: [
            {
              label: '失败次数',
              data: failListDesc,
              rateValues: hoursDesc.map(h => {
                const ok = data.hourly[h]?.success || 0;
                const fail = data.hourly[h]?.failed || 0;
                const total = ok + fail;
                return total > 0 ? Math.round((fail / total) * 100) : 0;
              }),
              backgroundColor: 'rgba(220, 38, 38, 0.45)',
              borderColor: '#dc2626',
              borderWidth: 1
            }
          ]
        },
        options: {
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true }
          }
        }
      });

      drawChart('rateLineChart', {
        type: 'line',
        data: {
          labels: hours,
          datasets: [
            {
              label: '连通率(%)',
              data: rateList,
              borderColor: '#2563eb',
              pointBackgroundColor: '#2563eb',
              pointRadius: 3,
              tension: 0.25
            }
          ]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });

      const tbody = document.getElementById('hourly24Body');
      const hourly24Desc = [...data.hourly_24].reverse();
      const now = new Date();
      const currentHourKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}`;
      const elapsedMinutes = Math.max(1, now.getMinutes());
      const currentHourItem = hourly24Desc.find(item => String(item.hour) === currentHourKey);
      let predictedCurrentHourFailed = null;
      if (currentHourItem) {
        const currentFailed = Number(currentHourItem.failed || 0);
        predictedCurrentHourFailed = Math.round((currentFailed / elapsedMinutes) * 60);
      }
      const maxFailed = Math.max(
        1,
        ...hourly24Desc.map(item => Number(item.failed || 0)),
        Number(predictedCurrentHourFailed || 0)
      );
      tbody.innerHTML = hourly24Desc.map(item => {
        const hourOnly = `${String(item.hour).split(' ')[1] || item.hour}:00`;
        const failed = Number(item.failed || 0);
        const connectivityRate = Math.round(Number(item.connectivity_rate || 0));
        const failedBarWidth = Math.round((failed / maxFailed) * 100);
        const rateBarWidth = Math.max(0, Math.min(100, Math.round(connectivityRate)));
        const isCurrentHour = String(item.hour) === currentHourKey;
        const predictedHourFailed = isCurrentHour
          ? Math.max(failed, Number(predictedCurrentHourFailed || failed))
          : failed;
        const predictedBarWidth = Math.round((predictedHourFailed / maxFailed) * 100);
        const predictedExtraWidth = Math.max(0, predictedBarWidth - failedBarWidth);
        return `
        <tr>
          <td>${hourOnly}</td>
          <td>${failed}</td>
          <td>
            <div class="bar-track">
              <div class="bar-fill fail" style="width:${failedBarWidth}%"></div>
              ${isCurrentHour && predictedExtraWidth > 0
                ? `<div class="bar-fill fail-pred" style="left:${failedBarWidth}%; width:${predictedExtraWidth}%"></div>`
                : ''}
            </div>
          </td>
          <td>${connectivityRate}%</td>
          <td>
            <div class="bar-track"><div class="bar-fill rate" style="width:${rateBarWidth}%"></div></div>
          </td>
        </tr>
      `;
      }).join('');

      const logBox = document.getElementById('logContent');
      const filteredLog = (logData.content || '')
        .split(/\r?\n/)
        .filter(line => line && !line.includes('\tsuccess\t'))
        .join('\n');
      logBox.value = filteredLog;
      logBox.scrollTop = logBox.scrollHeight;
    }

    loadStats();
  </script>
</body>
</html>
